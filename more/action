name: TF Apply
author: Sean Summers <ssummers@jetblue.com>
description: |
  Apply a TF plan, using an opinionated structure with
  an environments/{environment}/ folder containing all needed .tf{vars}
  files for an environment.
inputs:
  environment:
    description: The folder in environments/ (should also match AWS Account alias)
    required: true
runs:
  using: composite
  steps:
    - name: Setup OpenTofu
      uses: opentofu/setup-opentofu@v1
    - name: Download TF Plan and Backend Artifact
      uses: actions/download-artifact@v4
      with:
        name: ${{ inputs.environment }}
        path: environments/${{ inputs.environment }}
    - name: Restore TP Plan and .terraform.lock.hcl
      run: unzip -o tfplan .terraform.lock.hcl
      shell: bash
      working-directory: environments/${{ inputs.environment }}
    - name: Initialize TF
      id: init
      run: tofu init
      shell: bash
      working-directory: environments/${{ inputs.environment }}
      env:
        TF_IN_AUTOMATION: "1"
        TF_INPUT: "0"
        TF_CLI_ARGS: -no-color
        TF_CLI_ARGS_init: -reconfigure -lockfile=readonly
    - name: Apply TF
      id: apply
      run: tofu apply
      shell: bash
      working-directory: environments/${{ inputs.environment }}
      env:
        TF_IN_AUTOMATION: "1"
        TF_INPUT: "0"
        TF_CLI_ARGS: -no-color
        TF_CLI_ARGS_apply: tfplan
    - name: Create the apply summary
      uses: actions/github-script@v7
      if: always()
      id: summary
      continue-on-error: true
      env:
        APPLY: |
          tofu
          ${{ steps.apply.outputs.stdout }}
      with:
        result-encoding: string
        script: |
          // 1. Prep the output
          const output = `#### OpenTofu Apply ðŸš—\`${{ steps.apply.outcome }}\`

          <details><summary>Show details</summary>

          \`\`\`\n
          ${process.env.APPLY}
          \`\`\`

          </details>

          *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`, Working Directory: \`environments/${{ inputs.environment }}\`, Workflow: \`${{ github.workflow }}\`*`;

          // 2. Set the output variable
          const fs = require('fs');
          fs.writeFileSync('environments/${{ inputs.environment }}/summary.md', output);
          core.setOutput('summary', output);
    - name: Write the step summary
      if: always()
      continue-on-error: true
      run: cat environments/${{ inputs.environment }}/summary.md >> $GITHUB_STEP_SUMMARY
      shell: bash