name: package

on:
  workflow_call:
    secrets:
      JB_ARTIFACTORY_USER:
        required: true
      JB_ARTIFACTORY_SECRET:
        required: true

jobs:
  package:
    runs-on: [dind-runner-set]
    steps:
      - name: Checkout the repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Node
        uses: actions/setup-node@v3
        with:
          node-version: "18.16"
          cache: npm

      - uses: actions/download-artifact@v4
        with:
          name: dist
          path: ./dist

      # - name: Getting the docker file from crystalblue pipeline repo
      #   run: |
      #     curl -H 'Authorization: token ${{ steps.generate_token.outputs.token }}' -H 'Accept: application/vnd.github.v4.raw' -L "https://api.github.com/repos/jetblueairways/crystalblue-pipelines/contents/Dockerfile?ref=main" >Dockerfile
      #

      - name: Login to Jfrog Artifactory
        uses: jetblueairways/foundation-docker-action-login@v2.1.0
        with:
          registry: artifactory.it.jetblue.com
          username: ${{ secrets.JB_ARTIFACTORY_USER }}
          password: ${{ secrets.JB_ARTIFACTORY_SECRET }}

      - name: tag version
        id: tag_version
        uses: jetblueairways/foundation-rymndhng-release-on-push-action@v0.27.0
        with:
          bump_version_scheme: minor
          tag_prefix: v

      - name: verify tags
        run: |
          echo "Tag name ${{ steps.tag_version.outputs.tag_name }}"
          echo "Release version ${{ steps.tag_version.outputs.version }}"

      - name: Set npm config to JetBlue private repos
        run: |
          npm config set registry https://${{ vars.JB_ARTIFACTORY_URL }}/artifactory/api/npm/nodejs-virtual
          npm config set @cb-libraries:registry https://${{ vars.JB_ARTIFACTORY_URL }}/artifactory/api/npm/cb-libraries
          auth=$(echo -n '${{ secrets.JB_ARTIFACTORY_USER }}:${{ secrets.JB_ARTIFACTORY_SECRET }}' | base64)
          npm config set //${{ vars.JB_ARTIFACTORY_URL }}/artifactory/api/npm/:_auth=$auth

      - name: Build
        id: docker-build
        uses: jetblueairways/foundation-docker-action-build-push@v3.2.0
        with:
          tags: ${{ vars.JB_ARTIFACTORY_URL }}/${{ vars.JB_DOCKER_REPO_NAME }}/${{ github.event.repository.name }}:${{ steps.tag_version.outputs.version }}
          context: .
          load: true
          secret-files: |
            npmrc=/home/runner/.npmrc

      - name: Adding image as environment variable and removing .npmrc file
        run: |
          echo -e "IMAGE_NAME=${{ vars.JB_ARTIFACTORY_URL }}/${{ vars.JB_DOCKER_REPO_NAME }}/${{ github.event.repository.name }}:${{ steps.tag_version.outputs.version }}" >> $GITHUB_ENV
          rm ${HOME}/.npmrc

      - name: Prisma Cloud image scan
        id: image-scan
        uses: jetblueairways/foundation-prisma-cloud-scan-action@v1.6.2
        with:
          pcc_console_url: ${{ secrets.JB_PRISMA_URL }}
          pcc_user: ${{ secrets.JB_PRISMA_KEY }}
          pcc_pass: ${{ secrets.JB_PRISMA_SECRET }}
          image_name: ${{ env.IMAGE_NAME }}

      - name: Pushing the image after scan
        run: |
          docker push ${{ env.IMAGE_NAME }}
      #
      # - name: Triggering deploy job
      #   uses: jetblueairways/foundation-repository-dispatch-action@v2.1.1
      #   with:
      #     event-type: deployment
      #     client-payload: '{"tag": "${{ steps.tag_version.outputs.version }}"}'