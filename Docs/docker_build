name: package

on:
  workflow_call:
    inputs:
      tag:
        type: string
        default: ""
    secrets:
      JB_ACTIONS_PRIVATE_KEY:
        required: true
      JB_ARTIFACTORY_USER:
        required: true
      JB_ARTIFACTORY_SECRET:
        required: true

jobs:
  package:
    runs-on: [dind-runner-set]
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Generate token
        uses: actions/create-github-app-token@v1
        id: generate_token
        with:
          app-id: ${{ vars.JB_ACTIONS_APP_ID }}
          private-key: ${{ secrets.JB_ACTIONS_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
      
      - name: Checkout the repo
        if: ${{ !inputs.tag }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: "recursive"
          token: ${{ steps.generate_token.outputs.token }}

      - name: Checkout the repo at ref
        if: ${{ inputs.tag }}
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag }}
          submodules: "recursive"
          token: ${{ steps.generate_token.outputs.token }}

      - name: Install Node
        uses: actions/setup-node@v5
        with:
          node-version: "20.14"
          cache: npm

      - if: ${{ hashFiles('Dockerfile') == '' }}
        name: Getting the Dockerfile from crystalblue pipeline repo
        run: |
          curl -H 'Authorization: token ${{ steps.generate_token.outputs.token }}' -H 'Accept: application/vnd.github.v4.raw' -L "https://api.github.com/repos/jetblueairways/crystalblue-pipelines/contents/Dockerfile?ref=main" >Dockerfile

      - name: Login to Jfrog Artifactory
        uses: docker/login-action@v3
        with:
          registry: artifactory.it.jetblue.com
          username: ${{ secrets.JB_ARTIFACTORY_USER }}
          password: ${{ secrets.JB_ARTIFACTORY_SECRET }}

      - name: tag version
        if: ${{ !inputs.tag }}
        id: tag_version_auto
        uses: jetblueairways/foundation-rymndhng-release-on-push-action@v0.27.0
        with:
          bump_version_scheme: minor
          tag_prefix: v

      - name: set provided tag
        if: ${{ inputs.tag }}
        id: tag_version_manual
        run: |
          echo "version=${{ inputs.tag }}" >> $GITHUB_OUTPUT
          echo "tag_name=${{ inputs.tag }}" >> $GITHUB_OUTPUT

      - name: unify tag outputs
        id: tag_version
        run: |
          if [[ "${{ inputs.tag }}" == "" ]]; then
            echo "version=${{ steps.tag_version_auto.outputs.version }}" >> $GITHUB_OUTPUT
            echo "tag_name=${{ steps.tag_version_auto.outputs.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ steps.tag_version_manual.outputs.version }}" >> $GITHUB_OUTPUT
            echo "tag_name=${{ steps.tag_version_manual.outputs.tag_name }}" >> $GITHUB_OUTPUT
          fi

      - name: verify tags
        run: |
          echo "Tag name ${{ steps.tag_version.outputs.tag_name }}"
          echo "Release version ${{ steps.tag_version.outputs.version }}"

      - name: Set npm config to JetBlue private repos
        run: |
          npm config set registry https://${{ vars.JB_ARTIFACTORY_URL }}/artifactory/api/npm/nodejs-virtual
          npm config set @cb-libraries:registry https://${{ vars.JB_ARTIFACTORY_URL }}/artifactory/api/npm/cb-libraries
          auth=$(echo -n '${{ secrets.JB_ARTIFACTORY_USER }}:${{ secrets.JB_ARTIFACTORY_SECRET }}' | base64)
          npm config set //${{ vars.JB_ARTIFACTORY_URL }}/artifactory/api/npm/:_auth=$auth
          npm config set @jetblueairways:registry https://npm.pkg.github.com
          npm config set //npm.pkg.github.com/:_authToken=${{ steps.generate_token.outputs.token }}
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build
        id: docker-build
        uses: docker/build-push-action@v6
        with:
          tags: ${{ vars.JB_ARTIFACTORY_URL }}/${{ vars.JB_DOCKER_REPO_NAME }}/${{ github.event.repository.name }}:${{ steps.tag_version.outputs.version }}
          context: .
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true
          build-args: |
            GITHUB_SHA=${{ github.sha }}
            TAG_NAME=${{ steps.tag_version.outputs.tag_name }}
          secret-files: |
            npmrc=/home/runner/.npmrc

      - name: Adding image as environment variable and removing .npmrc file
        run: |
          echo -e "IMAGE_NAME=${{ vars.JB_ARTIFACTORY_URL }}/${{ vars.JB_DOCKER_REPO_NAME }}/${{ github.event.repository.name }}:${{ steps.tag_version.outputs.version }}" >> $GITHUB_ENV
          rm ${HOME}/.npmrc

      - name: Prisma Cloud image scan
        id: image-scan
        uses: PaloAltoNetworks/prisma-cloud-scan@v1.6.7
        with:
          pcc_console_url: ${{ secrets.JB_PRISMA_URL }}
          pcc_user: ${{ secrets.JB_PRISMA_KEY }}
          pcc_pass: ${{ secrets.JB_PRISMA_SECRET }}
          image_name: ${{ env.IMAGE_NAME }}

      - name: Pushing the image after scan
        run: |
          docker push ${{ env.IMAGE_NAME }}

      - name: Triggering deploy job
        uses: jetblueairways/foundation-repository-dispatch-action@v2.1.1
        with:
          event-type: deployment
          client-payload: '{"tag": "${{ steps.tag_version.outputs.version }}", "environment": "non_production"}'